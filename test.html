<!-- =============================[ STYLES ]============================= -->
<style>
    /*
      This approach uses an <iframe> to isolate the Bot Framework Web Chat instance
      from the main page, preventing potential DOM conflicts that cause the
      MutationObserver error.
  
      The main page only displays the bubble and the collapsible container (with iframe).
    */
  
    /* Wrapper to keep widget at bottom-right and on top */
    #besperChatWrapper {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 2147483647; /* Keep widget on top */
    }
  
    /* Floating bubble (widget) in requested color #022D54 */
    #besperChatBubble {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 60px;
      height: 60px;
      background-color: #022D54;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      color: #fff;
      font-family: sans-serif;
      font-weight: bold;
    }
  
    /* Collapsible chat container that holds the iframe */
    #besperChatContainer {
      position: absolute;
      bottom: 80px;
      right: 0;
      width: 350px;
      height: 500px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
      display: none; /* Toggled via .open */
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
  
    #besperChatContainer.open {
      display: block;
    }
  
    /* The iframe that will load Bot Framework Web Chat */
    #besperWebchatFrame {
      width: 100%;
      height: 100%;
      border: none; /* No borders around the iframe */
    }
  </style>
  
  
  <!-- =============================[ HTML ]============================= -->
  <div id="besperChatWrapper">
    <!-- Toggle bubble at bottom-right -->
    <div id="besperChatBubble" title="Toggle Chat">Chat</div>
  
    <!-- Collapsible container with iframe inside -->
    <div id="besperChatContainer">
      <iframe id="besperWebchatFrame"></iframe>
    </div>
  </div>
  
  
  <!-- =============================[ SCRIPTS ]============================= -->
  <!-- 1. BesperJS to retrieve Direct Line token -->
  <script src="https://unpkg.com/besperjs@1.0.1/src/index.js"></script>
  
  <!-- 2. Bot Framework Web Chat pinned to 4.15.7 (main page load) -->
  <script src="https://cdn.botframework.com/botframework-webchat/4.15.7/webchat.js"></script>
  
  <script>
    /**
     * Replace these with your actual Bot ID and environment.
     * This approach isolates Web Chat in an iframe, reducing DOM conflicts.
     */
    const botId = 'asst_H1Fr5RAWUdTWorW694uI7tjX'; // <-- REPLACE with your real Bot ID
    const environment = 'dev';                    // <-- REPLACE with your environment
  
    let webChatInitialized = false;
  
    document.addEventListener('DOMContentLoaded', () => {
      const bubble = document.getElementById('besperChatBubble');
      const container = document.getElementById('besperChatContainer');
  
      // Toggle the container's .open class on bubble click
      bubble.addEventListener('click', event => {
        event.stopPropagation();
        container.classList.toggle('open');
  
        // If opening for the first time, fetch token & init Web Chat in iframe
        if (container.classList.contains('open') && !webChatInitialized) {
          fetchTokenAndInitWebChat();
        }
      });
  
      // Close if user clicks completely outside the chat widget
      document.addEventListener('click', event => {
        if (!event.target.closest('#besperChatWrapper')) {
          container.classList.remove('open');
        }
      });
    });
  
    /**
     * Fetch Direct Line token from BesperJS, then initialize Web Chat in the iframe.
     */
    async function fetchTokenAndInitWebChat() {
      try {
        const directLineToken = await BesperBot.getSessionToken(botId, environment);
        console.log('Session Token:', directLineToken);
  
        initializeWebChat(directLineToken);
        webChatInitialized = true;
      } catch (err) {
        console.error('Error retrieving session token:', err);
        alert('Failed to connect to the chat service.');
      }
    }
  
    /**
     * Initialize Bot Framework Web Chat inside an iframe to prevent DOM conflicts.
     */
    function initializeWebChat(token) {
      const iframe = document.getElementById('besperWebchatFrame');
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
  
      // Write an entire mini-page into the iframe with Web Chat 4.15.7
      iframeDoc.open();
      iframeDoc.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <!-- Load the same pinned version of Web Chat inside the iframe -->
            <script src="https://cdn.botframework.com/botframework-webchat/4.15.7/webchat.js"></script>
            <style>
              html, body {
                height: 100%;
                margin: 0;
                padding: 0;
                background-color: #fff;
              }
              #webchat {
                height: 100%;
                width: 100%;
              }
            </style>
          </head>
          <body>
            <div id="webchat"></div>
            <script>
              // Use default Web Chat rendering for Adaptive Cards
              const styleOptions = {
                adaptiveCardsParserMaxVersion: '1.5',
                botAvatarImage: 'https://example.com/bot-avatar.png',
                userAvatarImage: 'https://example.com/user-avatar.png',
                // Additional style options can be added here
              };
  
              const directLine = window.WebChat.createDirectLine({ token: '${token}' });
  
              window.WebChat.renderWebChat({
                directLine,
                styleOptions,
                userID: 'user1',
                username: 'User',
                locale: 'en-US',
                sendTypingIndicator: true,
                renderMarkdown: true
              }, document.getElementById('webchat'));
            </script>
          </body>
        </html>
      `);
      iframeDoc.close();
    }
  </script>